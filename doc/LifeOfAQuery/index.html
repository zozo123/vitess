<!DOCTYPE html>
<html lang="en" itemscope itemtype="https://schema.org/WebPage">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Vitess / LifeOfAQuery</title>

        <!-- Webfont -->
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,400italic,500,500italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
    
    <!--<link rel="shortcut icon" type="image/png" href="/favicon.png">-->

    <!-- Bootstrap -->
    <link href="/libs/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Styles -->
    <link rel="stylesheet" type="text/css" href="/css/site.css" />
    <!-- Font Awesome icons -->
    <link href="/libs/font-awesome-4.4.0/css/font-awesome.min.css"
          rel="stylesheet"
          type="text/css">
    
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="/libs/bootstrap/js/bootstrap.min.js"></script>


    <!-- metadata -->
    <meta name="og:title" content="Vitess / LifeOfAQuery"/>
    <meta name="og:image" content="/images/120x120.gif"/>
    <meta name="og:description" content="Servers and tools that scale MySQL databases for the web in cloud architectures or on dedicated hardware."/>
  </head>
  <body class="docs" id="top_of_page">

    <span id="toc-depth" data-toc-depth="h2,h3"></span>


  	<nav id="common-nav" class="navbar navbar-fixed-top inverse">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">
        <img class="logo" src="/images/vitess-logo-large-cropped-2.png" alt="Vitess">
      </a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right" id="standard-menu-links">
        <li><a href="/overview/">Guides</a></li>
        <li><a href="/reference/vitess-api.html">Reference</a></li>
        <li><a href="https://github.com/youtube/vitess"><i class="fa fa-github"></i> GitHub</a></li>
        <!-- Hide link to blog unless we have actual posts -->
        <!-- <li><a href="/blog/" title="">Blog</a></li> -->
      </ul>
      <ul class="nav nav-stacked mobile-left-nav-menu" id="collapsed-left-menu">
                <li class="submenu">
          <h4 class="arrow-r no-top-margin">Overview</h4>
          <ul style="display: none">
            <li><a href="/overview/">What is Vitess</a></li>
            <li><a href="/overview/concepts.html">Key Concepts</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Getting Started</h4>
          <ul style="display: none">
            <li><a href="/getting-started/">Run Vitess on Kubernetes</a></li>
            <li><a href="/getting-started/local-instance.html">Run Vitess Locally</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">User Guide</h4>
          <ul style="display: none">
            <li><a href="/user-guide/introduction.html">Introduction</a>
            <li><a href="/user-guide/client-libraries.html">Client Libraries</a>
            <li><a href="/user-guide/backup-and-restore.html">Backing Up Data</a>
            <li><a href="/user-guide/reparenting.html">Reparenting</a></li>
            <li><a href="/user-guide/schema-management.html">Schema Management</a></li>
            <li style="padding-bottom: 0"><a href="/user-guide/sharding.html">Sharding</a>
              <ul style="list-style-type: none">
                <li><a href="/user-guide/horizontal-sharding.html">Horizontal Sharding (Codelab)</a></li>
                <li style="padding-bottom: 0"><a href="/user-guide/sharding-kubernetes.html">Sharding in Kubernetes (Codelab)</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Reference Guides</h4>
          <ul style="display: none">
            <li><a href="/reference/vitess-api.html">Vitess API</a>
            <li><a href="/reference/vtctl.html">vtctl Commands</a>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Other Resources</h4>
          <ul style="display: none">
            <li><a href="/resources/presentations.html">Presentations</a>
          </ul>
        </li>

        <li><a href="https://github.com/youtube/vitess" style="font-size: 18px; margin-left: 0.25em;"><i class="fa fa-github"></i> GitHub</a></li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>



<div id="masthead">
  <div class="container">
    <div class="row">
      <div class="col-md-9">
        <h1>LifeOfAQuery</h1>
      </div>
    </div>
  </div>
</div>


<div class="container">
    <div class="row scroll-margin" id="toc-content-row">
    <div class="col-md-3" id="leftCol">
      <ul class="nav nav-stacked mobile-left-nav-menu" id="sidebar">
                <li class="submenu">
          <h4 class="arrow-r no-top-margin">Overview</h4>
          <ul style="display: none">
            <li><a href="/overview/">What is Vitess</a></li>
            <li><a href="/overview/concepts.html">Key Concepts</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Getting Started</h4>
          <ul style="display: none">
            <li><a href="/getting-started/">Run Vitess on Kubernetes</a></li>
            <li><a href="/getting-started/local-instance.html">Run Vitess Locally</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">User Guide</h4>
          <ul style="display: none">
            <li><a href="/user-guide/introduction.html">Introduction</a>
            <li><a href="/user-guide/client-libraries.html">Client Libraries</a>
            <li><a href="/user-guide/backup-and-restore.html">Backing Up Data</a>
            <li><a href="/user-guide/reparenting.html">Reparenting</a></li>
            <li><a href="/user-guide/schema-management.html">Schema Management</a></li>
            <li style="padding-bottom: 0"><a href="/user-guide/sharding.html">Sharding</a>
              <ul style="list-style-type: none">
                <li><a href="/user-guide/horizontal-sharding.html">Horizontal Sharding (Codelab)</a></li>
                <li style="padding-bottom: 0"><a href="/user-guide/sharding-kubernetes.html">Sharding in Kubernetes (Codelab)</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Reference Guides</h4>
          <ul style="display: none">
            <li><a href="/reference/vitess-api.html">Vitess API</a>
            <li><a href="/reference/vtctl.html">vtctl Commands</a>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Other Resources</h4>
          <ul style="display: none">
            <li><a href="/resources/presentations.html">Presentations</a>
          </ul>
        </li>

      </ul>
    </div>
    <div class="col-md-2" id="rightCol">
      <div class="nav nav-stacked" id="tocSidebar">
        <div id="toc"></div>
      </div>
    </div>
    <div class="col-md-7" id="centerCol">
      <div id="centerTextCol">
        <h1 id="life-of-a-query">Life of A Query</h1>

<ul>
<li><a href="#from-client-to-vtgate">From Client to VtGate</a></li>
<li><a href="#from-vtgate-to-vttablet">From VtGate to VtTablet</a></li>
<li><a href="#from-vttablet-to-mysql">From VtTablet to MySQL</a></li>
<li><a href="#putting-it-all-together">Putting it all together</a></li>
<li><a href="#toposerver">TopoServer</a></li>
<li><a href="#streaming-query">Streaming Query</a></li>
<li><a href="#scatter-query">Scatter Query</a></li>
<li><a href="#misc">Misc</a>

<ul>
<li><a href="#rpc-server-code-path-vtgate">Rpc Server Code Path (VtGate)</a></li>
<li><a href="#vtgate-to-vttablet-code-path">VtGate to VtTablet Code Path</a></li>
<li><a href="#vttablet-to-mysql-code-path">VtTablet to MySQL Code Path</a></li>
</ul></li>
</ul>

<p>A query means a request for information from database and it involves four components in the case of Vitess, including the client application, VtGate, VtTablet and MySQL instance. This doc explains the interaction which happens between and within components.</p>

<p><img src="https://raw.githubusercontent.com/youtube/vitess/master/doc/life_of_a_query.png" alt=""></p>

<p>At a very high level, as the graph shows, first the client sends a query to VtGate. VtGate then resolves the query and routes it to the right VtTablets. For each VtTablet that receives the query, it does necessary validations and passes the query to the underlying MySQL instance. After gathering results from MySQL, VtTablet sends the response back to VtGate. Once VtGate receives responses from all VtTablets, it sends the combined result to the client. In the presence of VtTablet errors, VtGate will retry the query if errors are recoverable and it only fails the query if either errors are unrecoverable or the maximum number of retries has been reached.</p>

<h2 id="from-client-to-vtgate">From Client to VtGate</h2>

<p>A client application first sends a bson rpc with an embedded sql query to VtGate. VtGate&#39;s rpc server unmarshals this rpc request, calls the appropriate VtGate method and return its result back to client. VtGate has an rpc server that listens to localhost:port/_bson_rpc_ for http requests and localhost:port/_bson_rpc_/auth for https requests.</p>

<p><img src="https://raw.githubusercontent.com/youtube/vitess/master/doc/life_of_a_query_client_to_vtgate.png" alt=""></p>

<p>VtGate keeps an in-memory table that stores all available rpc methods for each service, e.g. VtGate uses &quot;VTGate&quot; as its service name and most of its methods defined in <a href="../go/vt/vtgate/vtgate.go">go/vt/vtgate/vtgate.go</a> are used to serve rpc request <a href="../go/rpcplus/server.go">go/rpcplus/server.go</a>.</p>

<h2 id="from-vtgate-to-vttablet">From VtGate to VtTablet</h2>

<p><img src="https://raw.githubusercontent.com/youtube/vitess/master/doc/life_of_a_query_vtgate_to_vttablet.png" alt=""></p>

<p>After receiving an rpc call from the client and one of its Execute* method being invoked, VtGate needs to figure out which shards should receive the query and send it to each of them. In addition, VtGate talks to the topo server to get necessary information to create a VtTablet connection for each shard. At this point, VtGate is able to send the query to the right VtTablets in parallel. VtGate also does retry if timeout happens or some VtTablets return recoverable errors.</p>

<p>Internally, VtGate has a ScatterConn instance and uses it to execute queries across multiple ShardConn connections. A ScatterConn performs the query on selected shards in parallel. It first obtains a ShardConn connection for every shard and sends the query using the ShardConn&#39;s execute method. If the requested session is in a transaction, it will open a new transaction on the connection, and update the Session with the transaction id. If the session already contains a transaction id for the shard, it reuses it. If there are any unrecoverable errors during a transaction, it rolls back the transaction for all shards.</p>

<p>A ShardConn object represents a load balanced connection to a group of VtTablets that belong to the same shard. ShardConn can be concurrently used across goroutines.</p>

<h2 id="from-vttablet-to-mysql">From VtTablet to MySQL</h2>

<p><img src="https://raw.githubusercontent.com/youtube/vitess/master/doc/life_of_a_query_vttablet_to_mysql.png" alt=""></p>

<p>Once VtTablet received an rpc call from VtGate, it does a few checks before passing the query to MySQL. First, it validates the current VtTablet state including the session id, then generates a query plan and applies predefined query rules and does ACL checks. It also checks whether the query hits the row cache and returns the result immediately if so. In addition, VtTablet consolidates duplicate queries from executing simultaneously and shares results between them. At this point, VtTablet has no way but pass the query down to MySQL layer and wait for the result.</p>

<h2 id="putting-it-all-together">Putting it all together</h2>

<p><img src="https://raw.githubusercontent.com/youtube/vitess/master/doc/life_of_a_query_all.png" alt=""></p>

<h2 id="toposerver">TopoServer</h2>

<p>A topo server stores information to help VtGate navigate the query to the right VtTablets. It contains keyspace to shards mappings, keyspace id to shards mappings and ports that a VtTablet listens to (EndPoint). VtGate caches this information in memory and periodically updates it if changes have happened in the topo server.</p>

<h2 id="streaming-query">Streaming Query</h2>

<p>Generally speaking, a streaming query means query results will be returned as a stream. In Vitess&#39; case, both VtGate and VtTablet will send results back as soon as it is available. VtTablet by default will collect a fixed number of rows returned from MySQL, send them back to VtGate and repeats the above step until all rows have been returned.</p>

<h2 id="scatter-query">Scatter Query</h2>

<p>A scatter query, as its name indicates, will hit multiple shards. In Vitess, a scatter query is recognized once VtGate determines a query needs to hit multiple VtTablets. VtGate then sends the query to these VtTablets, assembles the result after receiving all responses and returns the combined result to the client.</p>

<h2 id="misc">Misc</h2>

<h3 id="rpc-server-code-path-vtgate">Rpc Server Code Path (VtGate)</h3>

<p>Init an rpc server</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">go/cmd/vtgate/vtgate.go: main()  -&gt;
  go/vt/servenv/servenv.go: RunDefault() -&gt; // use the port specified in command line &quot;--port&quot;
    go/vt/servenv/run.go: Run(port int)  -&gt;
      go/vt/servenv/rpc.go: ServeRPC()  -&gt; // set up rpc server
        go/rpcwrap/bsonrpc/codec.go: ServeRPC()  -&gt; // set up bson rpc server
          go/rpcwrap/rpcwrap.go: ServeRPC(&quot;bson&quot;, NewServerCodec)  -&gt; // common code to register rpc server
</code></pre></div>
<p>ServeRPC(&quot;bson&quot;, NewServerCodec) registers an rpcHandler instance whose ServeHTTP(http.ResponseWriter, *http.Request) will be called for every http request</p>

<p>The rpc server handles the http request:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">go/rpcwrap/rpcwrap.go rpcHandler.ServeHTTP -&gt;
go/rpcwrap/rpcwrap.go rpcHandler.server.ServeCodecWithContext -&gt;
go/rpcplus/server.go Server.ServeCodecWithContext(context.Context, ServerCodec) (note: rpcHandler uses a global DefaultServer instance defined in the server.go) -&gt;
go/rpcplus/server.go Server.readRequest(ServeCodec) will use a given codec to extract (service, methodType, request, request arguments, reply value, keep reading)
</code></pre></div>
<p>Finally we do &quot;service.call(..)&quot; with parameters provided in the request. In the current setup, service.call will always call some method in VtGate (go/vt/vtgate/vtgate.go).</p>

<h3 id="vtgate-to-vttablet-code-path">VtGate to VtTablet Code Path</h3>

<p>Here is the code path for a query with keyspace id.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">go/vt/vtgate/vtgate.go VTGate.ExecuteKeyspaceIds(context.Context, *proto.KeyspaceIdQuery, *proto.QueryResult) -&gt;
  go/vt/vtgate/resolver.go resolver.ExecuteKeyspaceIds(context.Context, *proto.KeyspaceIdQuery) -&gt;
    go/vt/vtgate/resolver.go resolver.Execute -&gt;
      go/vt/vtgate/scatter_conn.go ScatterConn.Execute -&gt;
        go/vt/vtgate/scatter_conn.go ScatterConn.multiGo -&gt;
          go/vt/vtgate/scatter_conn.go ScatterConn.getConnection -&gt;
          go/vt/vtgate/shard_conn.go ShardConn.Execute -&gt;
            go/vt/vtgate/shard_conn.go ShardConn.withRetry -&gt;
              go/vt/vtgate/shard_conn.go ShardConn.getConn -&gt;
              go/vt/tabletserver/tabletconn/tablet_conn.go tabletconn.GetDialer -&gt;
              go/vt/tabletserver/tabletconn/tablet_conn.go tabletconn.TabletConn.Execute -&gt;
              go/vt/tabletserver/gorpctabletconn/conn.go TabletBson.Execute -&gt;
                go/vt/tabletserver/gorpctabletconn/conn.go TabletBson.rpcClient.Call -&gt;
                go/rpcplus/client.go rpcplus.Client.Call -&gt;
                  go/rpcplus/client.go rpcplus.Client.Go -&gt;
                    go/rpcplus/client.go rpcplus.Client.send
</code></pre></div>
<h3 id="vttablet-to-mysql-code-path">VtTablet to MySQL Code Path</h3>

<p>Here is the code path for a select query.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">go/vt/tabletserver/sqlquery.go SqlQuery.Execute -&gt;
go/vt/tabletserver/query_executor.go QueryExecutor.Execute -&gt;
go/vt/tabletserver/query_executor.go QueryExecutor.execSelect -&gt;
go/vt/tabletserver/request_context.go RequestContext.getConn -&gt; // QueryExecutor composes a RequestContext
go/vt/tabletserver/request_context.go RequestContext.fullFetch -&gt;
go/vt/tabletserver/request_context.go RequestContext.execSQL -&gt;
go/vt/tabletserver/request_context.go RequestContext.execSQLNoPanic -&gt;
go/vt/tabletserver/request_context.go RequestContext.execSQLOnce -&gt;
go/vt/dbconnpool/connection_pool.go PoolConnection.ExecuteFetch (current implementation is in DBConnection) -&gt;
go/vt/dbconnpool/connection.go PooledConnection.DBConnection.ExecuteFetch -&gt;
go/mysql/mysql.go mysql.Connection.ExecuteFetch -&gt;
go/mysql/mysql.go mysql.Connection.fetchAll
</code></pre></div>
      </div>
    </div>
  </div>

</div>


        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<!--    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>   -->
    <!-- Include all compiled plugins (below), or include individual files as needed -->
<!--
    <script src="/libs/bootstrap/js/bootstrap.min.js"></script>
-->
    <!-- Include the common site javascript -->
    <script src="/js/common.js" type="text/javascript" charset="utf-8"></script>


    <!-- GA -->
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  if (window.location.hostname == 'youtube.github.io') {
    ga('create', 'UA-60219601-1', 'auto');
    ga('send', 'pageview');
  }
</script>

  </body>
</html>
