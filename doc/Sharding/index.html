<!DOCTYPE html>
<html lang="en-US">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width" />
      <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Vitess - Sharding</title>
<meta name="description" content="Servers and tools that scale MySQL databases for the web in cloud architectures or on dedicated hardware.">

<link rel="canonical" href="http://vitess.io/doc/Sharding/">

<!-- Add to homescreen for Chrome on Android -->
<meta name="mobile-web-app-capable" content="yes">
<link rel="icon" sizes="196x196" href="/images/touch/chrome-touch-icon-196x196.png">

<!-- Add to homescreen for Safari on iOS -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Vitess">

<!-- Tile icon for Win8 (144x144 + tile color) -->
<meta name="msapplication-TileImage" content="/images/touch/ms-touch-icon-144x144-precomposed.png">
<meta name="msapplication-TileColor" content="#3372DF">

          <!-- Webfont -->
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,400italic,500,500italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
    
    <!--<link rel="shortcut icon" type="image/png" href="/favicon.png">-->

    <!-- Bootstrap -->
    <link href="/libs/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Less custom stylesheet -->
    <link rel="stylesheet/less" type="text/css" href="/css/style.less" />
    <link rel="stylesheet" type="text/css" href="/css/vitess.css">
    <!-- Font Awesome icons -->
    <link href="/libs/font-awesome-4.4.0/css/font-awesome.min.css"
          rel="stylesheet"
          type="text/css">
    
    <!-- Less clientside js script after all less stylesheets. -->
    <script src="/libs/less/less.min.js" type="text/javascript"></script>



      <link rel="stylesheet" href="/css/components.css">
      <link rel="stylesheet" href="/css/responsee.css">
      <!-- CUSTOM STYLE -->
      <link rel="stylesheet" href="/css/template-style.css">
      <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700,800&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
      <script type="text/javascript" src="/assets/scripts/jquery-1.8.3.min.js"></script>
      <script type="text/javascript" src="/assets/scripts/jquery-ui.min.js"></script>    
      <script type="text/javascript" src="/assets/scripts/modernizr.js"></script>
      <script type="text/javascript" src="/assets/scripts/responsee.js"></script>
      <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
      <![endif]-->
   </head>
   <body class="size-1140">
      <header id="app-bar" class="app-bar promote-layer">
         <div class="line">
            <div class="app-bar-container">
               <button id="menu" class="menu" title="Menu"></button>
               <h1 class="logo"><a href="/">Vitess</a></h1>
               <section class="app-bar-actions">
                  <a href="#"><i class="icon icon-chevron-up"></i> Top</a>
               </section>
            </div>
            <div class="navdrawer">
              <nav id="nav" class="navdrawer-container promote-layer">
                <h4>Navigation</h4>
                
<ul>
  
    <li >
      <a href="//"></a>
    </li>
  
    <li >
      <a href="/overview/">Guides</a>
    </li>
  
    <li >
      <a href="/reference/vtctl.html">Reference</a>
    </li>
  
  <li><a href="https://github.com/youtube/vitess">GitHub</a></li>
</ul>

              </nav>
            </div>
         </div>
      </header>
      <!-- ASIDE NAV AND CONTENT -->
      <div class="line">
         <div class="box  margin-bottom">
            <div class="margin">
               <!-- ASIDE NAV 2 -->
               <nav class="scrolling-nav" style="margin:0">
               <aside class="s-12">
                  
                  <div class="aside-nav">
                     <div class="aside-nav-header">Overview</div>
                     <ul>
                        <li><a href="/overview/">What is Vitess</a></li>
                        <li><a href="/overview/concepts.html">Key Concepts</a></li>
                     </ul>
                     <div class="aside-nav-header">Getting Started</div>
                     <ul>
                        <li><a href="/getting-started/">Run Vitess on Kubernetes</a></li>
                        <li><a href="/getting-started/local-instance.html">Run Vitess Locally</a></li>
                     </ul>
                     <div class="aside-nav-header">User Guide</div>
                     <ul>
                        <li><a href="/user-guide/introduction.html">Introduction</a>
                        <li><a href="/user-guide/client-libraries.html">Client Libraries</a>
                        <li><a href="/user-guide/backup-and-restore.html">Backing Up Data</a>
                        <li><a href="/user-guide/reparenting.html">Reparenting</a></li>
                        <li><a href="/user-guide/schema-management.html">Schema Management</a></li>
                        <li><a href="/user-guide/sharding.html">Sharding</a>
                          <ul>
                            <li><a href="/user-guide/horizontal-sharding.html">Horizontal Sharding (Codelab)</a></li>
                            <li><a href="/user-guide/sharding-kubernetes.html">Sharding in Kubernetes (Codelab)</a></li>
                          </ul>
                        </li>
<!--
                        <li><a href="/user-guide/storage.html">Storage</a></li>
                        <li><a href="/user-guide/api.html">Using the API</a></li>
-->
                     </ul>
<!--
                     <div class="aside-nav-header">Architecture</div>
                     <ul>
                        <li><a href="/architecture/life-of-a-query.html">Life of a Query</a></li>
                        <li><a href="/architecture/topology-service.html">Topology Service</a></li>
                     </ul>

                     <div class="aside-nav-header">Maintenance</div>
                     <ul>
                        <li><a href="/maintenance/monitoring.html">Monitoring</a></li>
                        <li><a href="/maintenance/testing.html">Testing</a></li>
                     </ul>
-->
                     <div class="aside-nav-header">Other Resources</div>
                     <ul>
                        <li><a href="/resources/presentations.html">Presentations</a></li>
                        <!--<li class="last"><a href="/resources/roadmap.html">Roadmap</a></li>-->
                     </ul>
                  </div>
                  
               </aside>
               </nav>
               <!-- CONTENT -->
               <section class="s-12 l-9">
                 <article class="main-content-container">
                   <main class="clear">

  <header class="page-header container">
    <h2 class="xxlarge text-divider">Sharding</h2>
    
  </header>

  <div class="container">
    <p>Sharding is a method of horizontally partitioning a database to store
data across two or more database servers. This document explains how
sharding works in Vitess and the types of sharding that Vitess supports.</p>

<p><strong>Contents:</strong></p>

<div id="toc"></div>

<h2 id="overview">Overview</h2>

<p>In Vitess, a shard is a partition of a keyspace. In turn, the keyspace
might be a partition of the whole database. For example, a database might
have one keyspace for product data and another for user data. The shard
contains a subset of records within its keyspace.</p>

<p>For example, if an application&#39;s &quot;user&quot; keyspace is split into two
shards, each shard contains records for approximately half of the
application&#39;s users. Similarly, each user&#39;s information is stored
in only one shard.</p>

<p>A Vitess shard typically contains one MySQL master and many MySQL
slaves. The master handles write operations, while slaves handle
read-only traffic, batch processing operations, and other tasks.
Each MySQL instance within the shard should have the same data,
excepting some replication lag.</p>

<h3 id="supported-operations">Supported Operations</h3>

<p>Vitess supports the following types of sharding operations:</p>

<ul>
<li><strong>Horizontal sharding:</strong> Splitting or merging shards in a sharded keyspace</li>
<li><strong>Vertical sharding:</strong> Moving tables from an unsharded keyspace to
a different keyspace.</li>
</ul>

<p>With these features, you can start with a single keyspace that contains
all of your data (in multiple tables). As your database grows, you can
move tables to different keyspaces and shard some or all of those keyspaces
without any real downtime for your application.</p>

<h2 id="range-based-sharding">Range-based Sharding</h2>

<p>Vitess uses range-based sharding to manage data across multiple shards.
(Vitess can also support a <a href="#custom-sharding">custom sharding</a> scheme.</p>

<p>In range-based sharding, each record in a keyspace is associated with
a sharding key that is stored with the record. The sharding key value
is also the primary key for sharded data. Records with the same sharding
key are always collocated on the same shard.</p>

<p><strong>Note:</strong> The API uses the term &quot;keyspace ID&quot; to refer to the sharding key.</p>

<p>The full set of shards covers the range of possible sharding key values.
To guarantee a balanced use of shards, the sharding scheme should
ensure an even distribution of sharding keys across the keyspace&#39;s
shards. That distribution makes it easier to reshard the keyspace
at a later time using a more granular division of sharding keys.</p>

<p>Vitess calculates the sharding key or keys for each query and then
routes that query to the appropriate shards. For example, a query
that updates information about a particular user might be directed to
a single shard in the application&#39;s &quot;user&quot; keyspace. On the other hand,
a query that retrieves information about several products might be
directed to one or more shards in the application&#39;s &quot;product&quot; keyspace.</p>

<h3 id="sharding-keys">Sharding Keys</h3>

<p>As discussed above, Vitess calculates the sharding keys associated
with any particular query and then routes the query to the appropriate
shards.</p>

<p>Vitess supports two types of sharding keys:</p>

<ul>
<li><p><strong>Binary data:</strong> The key is an array of bytes. Vitess uses regular
byte-array comparison to determine which shard should handle the
query. The MySQL representation for this type of sharding key is
a <code>VARBINARY</code> field.</p></li>
<li><p><strong>64-bit unsigned integer:</strong> Vitess converts the 64-bit integer into
a byte array by copying the bytes, most significant byte first,
into 8 bytes. Vitess then uses byte-array comparison to identify the
right shards to handle the query. The MySQL representation for this
type of sharding key is a <code>bigint(20) UNSIGNED</code> field.</p></li>
</ul>

<p>A sharded keyspace contains information about the type of sharding key
that the keyspace uses. Each database table in the shard has a column
that stores the sharding key associated with each row in the table. The
sharding key column in each table has the same name and column type.</p>

<p>A common example of a sharding key is the 64-bit hash of a user ID. The
hashing function ensures that the sharding keys are evenly distributed
in the space.</p>

<h3 id="key-ranges-and-partitions">Key Ranges and Partitions</h3>

<p>Vitess uses key ranges to determine which shards should handle any
particular query.</p>

<ul>
<li>A <strong>key range</strong> is a series of consecutive sharding key values. It
has starting and ending values. A key falls inside the range if
it is equal to or greater than the start value and strictly less
than the end value.</li>
<li>A <strong>partition</strong> represents a set of key ranges that covers the entire
space.</li>
</ul>

<p>When building the serving graph for a keyspace that uses range-based
sharding, Vitess ensures that each shard is valid and that the shards
collectively constitute a full partition. In each keyspace, one shard
must have a key range with an empty start value and one shard, which
could be the same shard, must have a key range with an empty end value.</p>

<ul>
<li>An empty start value represents the lowest value, and all values are
greater than it.</li>
<li>An empty end value represents a value larger than the highest possible
value, and all values are strictly lower than it.</li>
</ul>

<p>Vitess always converts sharding keys to byte arrays before routing
queries. The value [ 0x80 ] is the middle value for sharding keys.
So, in a keyspace with two shards, sharding keys that have a byte-array
value lower than 0x80 are assigned to one shard. Keys with a byte-array
value equal to or higher than 0x80 are assigned to the other shard.</p>

<p>Several sample key ranges are shown below:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">Start</span><span class="o">=[]</span>, <span class="nv">End</span><span class="o">=[]</span>: Full Key Range
<span class="nv">Start</span><span class="o">=[]</span>, <span class="nv">End</span><span class="o">=[</span>0x80<span class="o">]</span>: Lower half of the Key Range.
<span class="nv">Start</span><span class="o">=[</span>0x80<span class="o">]</span>, <span class="nv">End</span><span class="o">=[]</span>: Upper half of the Key Range.
<span class="nv">Start</span><span class="o">=[</span>0x40<span class="o">]</span>, <span class="nv">End</span><span class="o">=[</span>0x80<span class="o">]</span>: Second quarter of the Key Range.
</code></pre></div>
<p>Two key ranges are consecutive if the end value of one range equals the
start value of the other range.</p>

<h3 id="shard-names-in-range-based-keyspaces">Shard Names in Range-Based Keyspaces</h3>

<p>In range-based, sharded keyspaces, a shard&#39;s name identifies the start
and end of the shard&#39;s key range, printed in hexadecimal and separated
by a hyphen. For instance, if a shard&#39;s key range is the array of bytes
beginning with [ 0x80 ] and ending, noninclusively, with [ 0xc0], then
the shard&#39;s name is <code>80-c0</code>.</p>

<p>Using this naming convention, the following four shards would be a valid
full partition:</p>

<ul>
<li>-40</li>
<li>40-80</li>
<li>80-c0</li>
<li>c0-</li>
</ul>

<h2 id="resharding">Resharding</h2>

<p>In Vitess, resharding describes the process of updating the sharding
scheme for a keyspace and dynamically reorganizing data to match the
new scheme. During resharding, Vitess can split or merge consecutive
shards very quickly, completing most data transitions with less than
five seconds of read-only downtime. During that time, existing data
can be read, but new data cannot be written.</p>

<p>The table below lists the sharding (or resharding) processes that you
would typically perform for different types of requirements:</p>

<table><thead>
<tr>
<th>Requirement</th>
<th>Action</th>
</tr>
</thead><tbody>
<tr>
<td>Uniformly increase read capacity</td>
<td>Add replicas or split shards</td>
</tr>
<tr>
<td>Uniformly increase write capacity</td>
<td>Split shards</td>
</tr>
<tr>
<td>Reclaim free space</td>
<td>Merge shards and/or keyspaces</td>
</tr>
<tr>
<td>Increase geo-diversity</td>
<td>Add new cells and replicas</td>
</tr>
<tr>
<td>Cool a hot tablet</td>
<td>For read access, add replicas or split shards. For write access, split shards.</td>
</tr>
</tbody></table>

<h3 id="filtered-replication">Filtered Replication</h3>

<p>The cornerstone of resharding is replicating the right data. Vitess
implements the following functions to support filtered replication,
the process that ensures that the correct source tablet data is
transferred to the proper destination tablets. Since MySQL does not
support any filtering, this functionality is all specific to Vitess.</p>

<ol>
<li>The source tablet tags transactions with comments so that MySQL binlogs
contain the filtering data needed during the resharding process. The
comments describe the scope of each transaction (its keyspace ID,
table, etc.).</li>
<li>A server process uses the comments to filter the MySQL binlogs and
stream the correct data to the destination tablet.</li>
<li>A client process on the destination tablet applies the filtered logs,
which are just regular SQL statements at this point.</li>
</ol>

<h3 id="additional-tools-and-processes">Additional Tools and Processes</h3>

<p>Vitess provides the following tools to help manage range-based shards:</p>

<ul>
<li>The <a href="/reference/vtctl.html">vtctl</a> command-line tool supports
functions for managing keyspaces, shards, tablets, and more.</li>
<li>Client APIs account for sharding operations.</li>
<li>The <a href="https://github.com/youtube/vitess/blob/master/java/vtgate-client/src/main/java/com/youtube/vitess/vtgate/hadoop/README.md">MapReduce framework</a>
fully utilizes key ranges to read data as quickly as possible,
concurrently from all shards and all replicas.</li>
</ul>

<h2 id="custom-sharding">Custom Sharding</h2>

<p>If your application already supports sharding or if you want to control
exactly which shard handles each query, Vitess can support your custom
sharding scheme. In that use case, each keyspace has a collection of
shards, and the client code always specifies the shard to which it is
directing a query.</p>

<p>One example of a custom sharding scheme is lookup-based sharding. In
lookup-based sharding, one keyspace is used as a lookup keyspace, and
it contains the mapping between a record&#39;s identifying key and the name
of the record&#39;s shard. To execute a query, the client first checks the
lookup table to locate the correct shard name and then routes the query
to that shard.</p>

<p>In a custom sharding scheme, shards can use any name you choose, and
they are always addressed by name. The vtgate API calls to use are
<code>ExecuteShard</code>, <code>ExecuteBatchShard</code>, and
<code>StreamExecuteShard</code>. None of the API calls for
<strong>KeyspaceIds</strong>, <strong>KeyRanges</strong>, or <strong>EntityIds</strong> are compatible with
a custom sharding scheme. Vitess&#39; tools and processes for automated
resharding also do not support custom sharding schemes.</p>

<p>If you use a custom sharding scheme, you can still use the
<a href="https://github.com/youtube/vitess/blob/master/java/vtgate-client/src/main/java/com/youtube/vitess/vtgate/hadoop/README.md">MapReduce framework</a>
to iterate over the data on multiple shards.</p>

  </div>

</main>

                 </article>
               </section>
            </div>
         </div>
         <footer>
            <div class="s-12">
               <div style="float: left; display: inline-block; width: 50%;">&copy; 2015 Google. Licensed under <a href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>.</div>
               <div style="float: right; display: inline-block; text-align: right; width: 50%;">Design and coding based on <a href="http://www.myresponsee.com" title="Responsee - lightweight responsive framework">Responsee</a> framework</div>
               </div>
         </footer>
      </div>
      <!-- FOOTER -->

      <script src="/assets/scripts/main.js"></script>

      <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  if (window.location.hostname == 'youtube.github.io') {
    ga('create', 'UA-60219601-1', 'auto');
    ga('send', 'pageview');
  }
</script>

   </body>
</html>
