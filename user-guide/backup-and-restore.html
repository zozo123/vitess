<!DOCTYPE html>
<html lang="en" itemscope itemtype="https://schema.org/WebPage">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Vitess / Backing Up Data</title>

        <!-- Webfont -->
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,400italic,500,500italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
    
    <!--<link rel="shortcut icon" type="image/png" href="/favicon.png">-->

    <!-- Bootstrap -->
    <link href="/libs/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Styles -->
    <link rel="stylesheet" type="text/css" href="/css/site.css" />
    <!-- Font Awesome icons -->
    <link href="/libs/font-awesome-4.4.0/css/font-awesome.min.css"
          rel="stylesheet"
          type="text/css">
    
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="/libs/bootstrap/js/bootstrap.min.js"></script>


    <!-- metadata -->
    <meta name="og:title" content="Vitess / Backing Up Data"/>
    <meta name="og:image" content="/images/120x120.gif"/>
    <meta name="og:description" content="Servers and tools that scale MySQL databases for the web in cloud architectures or on dedicated hardware."/>
  </head>
  <body class="docs" id="top_of_page">

    <span id="toc-depth" data-toc-depth="h2,h3"></span>


  	<nav id="common-nav" class="navbar navbar-fixed-top inverse">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">
        <img class="logo" src="/images/vitess-logo-large-cropped-2.png" alt="Vitess">
      </a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right" id="standard-menu-links">
        <li><a href="/overview/">Guides</a></li>
        <li><a href="/reference/vitess-api.html">Reference</a></li>
        <li><a href="https://github.com/youtube/vitess"><i class="fa fa-github"></i> GitHub</a></li>
        <!-- Hide link to blog unless we have actual posts -->
        <!-- <li><a href="/blog/" title="">Blog</a></li> -->
      </ul>
      <ul class="nav nav-stacked mobile-left-nav-menu" id="collapsed-left-menu">
                <li class="submenu">
          <h4 class="arrow-r no-top-margin">Overview</h4>
          <ul style="display: none">
            <li><a href="/overview/">What is Vitess</a></li>
            <li><a href="/overview/concepts.html">Key Concepts</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Getting Started</h4>
          <ul style="display: none">
            <li><a href="/getting-started/">Run Vitess on Kubernetes</a></li>
            <li><a href="/getting-started/local-instance.html">Run Vitess Locally</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">User Guide</h4>
          <ul style="display: none">
            <li><a href="/user-guide/introduction.html">Introduction</a>
            <li><a href="/user-guide/client-libraries.html">Client Libraries</a>
            <li><a href="/user-guide/backup-and-restore.html">Backing Up Data</a>
            <li><a href="/user-guide/reparenting.html">Reparenting</a></li>
            <li><a href="/user-guide/schema-management.html">Schema Management</a></li>
            <li style="padding-bottom: 0"><a href="/user-guide/sharding.html">Sharding</a>
              <ul style="list-style-type: none">
                <li><a href="/user-guide/horizontal-sharding.html">Horizontal Sharding (Codelab)</a></li>
                <li style="padding-bottom: 0"><a href="/user-guide/sharding-kubernetes.html">Sharding in Kubernetes (Codelab)</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Reference Guides</h4>
          <ul style="display: none">
            <li><a href="/reference/vitess-api.html">Vitess API</a>
            <li><a href="/reference/vtctl.html">vtctl Commands</a>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Other Resources</h4>
          <ul style="display: none">
            <li><a href="/resources/presentations.html">Presentations</a>
          </ul>
        </li>

        <li><a href="https://github.com/youtube/vitess" style="font-size: 18px; margin-left: 0.25em;"><i class="fa fa-github"></i> GitHub</a></li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>



<div id="masthead">
  <div class="container">
    <div class="row">
      <div class="col-md-9">
        <h1>Backing Up Data</h1>
      </div>
    </div>
  </div>
</div>


<div class="container">
    <div class="row scroll-margin" id="toc-content-row">
    <div class="col-md-3" id="leftCol">
      <ul class="nav nav-stacked mobile-left-nav-menu" id="sidebar">
                <li class="submenu">
          <h4 class="arrow-r no-top-margin">Overview</h4>
          <ul style="display: none">
            <li><a href="/overview/">What is Vitess</a></li>
            <li><a href="/overview/concepts.html">Key Concepts</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Getting Started</h4>
          <ul style="display: none">
            <li><a href="/getting-started/">Run Vitess on Kubernetes</a></li>
            <li><a href="/getting-started/local-instance.html">Run Vitess Locally</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">User Guide</h4>
          <ul style="display: none">
            <li><a href="/user-guide/introduction.html">Introduction</a>
            <li><a href="/user-guide/client-libraries.html">Client Libraries</a>
            <li><a href="/user-guide/backup-and-restore.html">Backing Up Data</a>
            <li><a href="/user-guide/reparenting.html">Reparenting</a></li>
            <li><a href="/user-guide/schema-management.html">Schema Management</a></li>
            <li style="padding-bottom: 0"><a href="/user-guide/sharding.html">Sharding</a>
              <ul style="list-style-type: none">
                <li><a href="/user-guide/horizontal-sharding.html">Horizontal Sharding (Codelab)</a></li>
                <li style="padding-bottom: 0"><a href="/user-guide/sharding-kubernetes.html">Sharding in Kubernetes (Codelab)</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Reference Guides</h4>
          <ul style="display: none">
            <li><a href="/reference/vitess-api.html">Vitess API</a>
            <li><a href="/reference/vtctl.html">vtctl Commands</a>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Other Resources</h4>
          <ul style="display: none">
            <li><a href="/resources/presentations.html">Presentations</a>
          </ul>
        </li>

      </ul>
    </div>
    <div class="col-md-2" id="rightCol">
      <div class="nav nav-stacked" id="tocSidebar">
        <div id="toc"></div>
      </div>
    </div>
    <div class="col-md-7" id="centerCol">
      <div id="centerTextCol">
        <p>This document explains how to create and restore data backups with
Vitess. Vitess uses backups for two purposes:</p>

<ul>
<li>Provide a point-in-time backup of the data on a tablet</li>
<li>Bootstrap new tablets in an existing shard</li>
</ul>

<h2 id="prerequisites">Prerequisites</h2>

<p>Vitess stores data backups on a Backup Storage service. Currently,
Vitess only supports backups to an NFS directory and can use any
network-mounted drive as the backup repository. The core Vitess software&#39;s
<a href="https://github.com/youtube/vitess/blob/master/go/vt/mysqlctl/backupstorage/interface.go">interface.go</a>
file defines an interface for the Backup Storage service. The interface
defines methods for creating, listing, and removing backups.</p>

<p>Before you can back up or restore a tablet, you need to ensure that the
tablet is aware of the Backup Storage system that you are using. To do so,
use the following command-line flags when starting a vttablet that has
access to a local file system where you are storing backups. In practice,
you should always use these flags when starting a tablet that has access
to backups on a local file system.</p>

<table class="responsive">
  <thead>
    <tr>
      <th colspan="2">Flags</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><nobr><code>--backup_storage_implementation</code></nobr></td>
      <td>Specifies the implementation of the Backup Storage interface to use.<br><br>If you run Vitess on a machine that has access to an NFS directory where you store backups, set the flag's value to file. Otherwise, do not set this flag or either of the other remaining flags.</td>
    </tr>
    <tr>
      <td><nobr><code>--file_backup_storage_root</code></nobr></td>
      <td>Identifies the root directory for backups. Set this flag if the backup_storage_implementation flag is set to file.</td>
    </tr>
    <tr>
      <td><nobr><code>--restore_from_backup</code></nobr></td>
      <td>Indicates that, when started, the tablet should restore the most recent backup from the file_backup_storage_root directory. This flag is only relevant if the other two flags listed above are also set.</td>
    </tr>
  </tbody>
</table>

<h2 id="creating-a-backup">Creating a backup</h2>

<p>Run the following vtctl command to create a backup:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctl Backup &lt;tablet-alias&gt;
</code></pre></div>
<p>In response to this command, the designated tablet performs the following sequence of actions:</p>

<ol>
<li><p>Removes itself from the healthy serving tablets in the serving graph.</p></li>
<li><p>Shuts down its mysqld process.</p></li>
<li><p>Copies the necessary files to the Backup Storage implementation
that was specified when the tablet was started.</p></li>
<li><p>Restarts mysql.</p></li>
<li><p>Restarts replication. By default, the tablet changes its status to
<code>spare</code> until it catches up on replication and proceeds
to the next step.
If you override the default, recommended behavior by setting the
____ flag to ____ when starting the tablet,
the tablet will restart replication and then proceed to the following
step even if it has not caught up on the replication process.</p></li>
<li><p>Updates the serving graph to rejoin the cluster as a healthy, serving tablet.</p></li>
</ol>

<h2 id="restoring-a-backup">Restoring a backup</h2>

<p>When a tablet starts, Vitess checks the value of the
<code>--restore_from_backup</code> command-line flag to determine whether
to restore a backup to that tablet.</p>

<ul>
<li>If the flag is present, Vitess tries to restore the most recent backup
from the Backup Storage system when starting the tablet.</li>
<li>If the flag is absent, Vitess does not try to restore a backup to the
tablet. This is the equivalent of starting a new tablet in a new shard.</li>
</ul>

<p>As noted in the <a href="#prerequisites">Prerequisites</a> section, the flag is
generally enabled all of the time for all of the tablets in a shard.
If Vitess cannot find a backup in the Backup Storage system, it just
starts the vttablet as a new tablet.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vttablet ... -backup_storage_implementation<span class="o">=</span>file <span class="se">\</span>
             -file_backup_storage_root<span class="o">=</span>/nfs/XXX <span class="se">\</span>
             -restore_from_backup
</code></pre></div>
<h2 id="managing-backups">Managing backups</h2>

<p><strong>vtctl</strong> provides two commands for managing backups:</p>

<ul>
<li><p><a href="/reference/vtctl.html#listbackups">ListBackups</a> displays the
existing backups for a keyspace/shard in chronological order.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctl ListBackups &lt;keyspace/shard&gt;
</code></pre></div></li>
<li><p><a href="/reference/vtctl.html#removebackup">RemoveBackup</a> deletes a
specified backup for a keyspace/shard.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">RemoveBackup &lt;keyspace/shard&gt; &lt;backup name&gt;
</code></pre></div></li>
</ul>

<h2 id="bootstrapping-a-new-tablet">Bootstrapping a new tablet</h2>

<p>The following steps explain how the backup process is used to bootstrap
new tablets as part of the normal lifecyle of a shard:</p>

<ol>
<li><p>A shard is initially created without an existing backup, and all
of the shard&#39;s tablets are started as spares.</p></li>
<li><p>By default, Vitess enables health checks on each tablet. As long as
these default checks are used, each tablet recognizes that replication
is not running and remains in an unhealthy state as a spare tablet.</p></li>
<li><p>After the requisite number of spare tablets is running, vtctl&#39;s
<a href="/reference/vtctl.html#initshardmaster">InitShardMaster</a> command
designates one tablet as the master. The remaining tablets are
slaves of the master tablet. In the serving graph, the master
tablet is in a healthy state, but the slaves remain unhealthy
because no database exists.</p></li>
<li><p>The initial schema is applied to the master using either usual schema
change tools or vtctl&#39;s
<a href="/reference/vtctl.html#copyschemashard">CopySchemaShard</a> command.
That command is typically used during resharding to clone data to a
destination shard. After being applied to the master tablet, the
schema propagates to the slave tablets.</p></li>
<li><p>The slave tablets all transition to a healthy state like
<code>rdonly</code> or <code>replica</code>. At this point,
the shard is working and functional.</p></li>
<li><p>Once the shard is accumulating data, a cron job runs regularly to
create new backups. Backups are created frequently enough to ensure
that one is always available if needed.</p>

<p>To determine the proper frequency for creating backups, consider
the amount of time that you keep replication logs and allow enough
time to investigate and fix problems in the event that a backup
operation fails.</p>

<p>For example, suppose you typically keep four days of replication logs
and you create daily backups. In that case, even if a backup fails,
you have at least a couple of days from the time of the failure to
investigate and fix the problem.</p></li>
<li><p>When a spare tablet comes up, it restores the latest backup, which
contains data as well as the backup&#39;s replication position. The
tablet then resets its master to the current shard master and starts
replicating.</p>

<p>This process is the same for new slave tablets and slave tablets that
are being restarted. For example, to add a new rdonly tablet to your
existing implementation, you would run the following steps:</p>

<ol>
<li>Run the vtctl <a href="/reference/vtctl.html#inittablet">InitTablet</a>
command to create the new tablet as a spare. Specify the
appropriate values for the <nobr><code>-keyspace</code></nobr>
and <nobr><code>-shard</code></nobr> flags, enabling Vitess to
identify the master tablet associated with the new spare.</li>
<li>Start the tablet using the flags specified in the
<a href="#prerequisites">Prerequisites</a> section. As described earlier in
this step, the new tablet will load the latest backup, reset its
master tablet, and start replicating.</li>
</ol></li>
</ol>

<h2 id="concurrency">Concurrency</h2>

<p>The back-up and restore processes simultaneously copy and either
compress or decompress multiple files to increase throughput. You
can control the concurrency using command-line flags:</p>

<ul>
<li>The vtctl <a href="/reference/vtctl.html#backup">Backup</a> command uses the
<code>-concurrency</code> flag.</li>
<li>vttablet uses the <code>-restore_concurrency</code> flag.</li>
</ul>

<p>If the network link is fast enough, the concurrency matches the CPU
usage of the process during the backup or restore process.</p>

      </div>
    </div>
  </div>

</div>


        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<!--    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>   -->
    <!-- Include all compiled plugins (below), or include individual files as needed -->
<!--
    <script src="/libs/bootstrap/js/bootstrap.min.js"></script>
-->
    <!-- Include the common site javascript -->
    <script src="/js/common.js" type="text/javascript" charset="utf-8"></script>


    <!-- GA -->
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-60219601-1', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
