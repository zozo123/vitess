<!DOCTYPE html>
<html lang="en" itemscope itemtype="https://schema.org/WebPage">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Vitess / Sharding in Kubernetes</title>

        <!-- Webfont -->
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,400italic,500,500italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
    
    <!--<link rel="shortcut icon" type="image/png" href="/favicon.png">-->

    <!-- Bootstrap -->
    <link href="/libs/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Styles -->
    <link rel="stylesheet" type="text/css" href="/css/site.css" />
    <!-- Font Awesome icons -->
    <link href="/libs/font-awesome-4.4.0/css/font-awesome.min.css"
          rel="stylesheet"
          type="text/css">
    
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="/libs/bootstrap/js/bootstrap.min.js"></script>


    <!-- metadata -->
    <meta name="og:title" content="Vitess / Sharding in Kubernetes"/>
    <meta name="og:image" content="/images/120x120.gif"/>
    <meta name="og:description" content="Servers and tools that scale MySQL databases for the web in cloud architectures or on dedicated hardware."/>
  </head>
  <body class="docs" id="top_of_page">

    <span id="toc-depth" data-toc-depth="h2,h3"></span>


  	<nav id="common-nav" class="navbar navbar-fixed-top inverse">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">
        <img class="logo" src="/images/vitess-logo-large-cropped-2.png" alt="Vitess">
      </a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right" id="standard-menu-links">
        <li><a href="/overview/">Guides</a></li>
        <li><a href="/reference/vitess-api.html">Reference</a></li>
        <li><a href="https://github.com/youtube/vitess"><i class="fa fa-github"></i> GitHub</a></li>
        <!-- Hide link to blog unless we have actual posts -->
        <!-- <li><a href="/blog/" title="">Blog</a></li> -->
      </ul>
      <ul class="nav nav-stacked mobile-left-nav-menu" id="collapsed-left-menu">
                <li class="submenu">
          <h4 class="arrow-r no-top-margin">Overview</h4>
          <ul style="display: none">
            <li><a href="/overview/">What is Vitess</a></li>
            <li><a href="/overview/concepts.html">Key Concepts</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Getting Started</h4>
          <ul style="display: none">
            <li><a href="/getting-started/">Run Vitess on Kubernetes</a></li>
            <li><a href="/getting-started/local-instance.html">Run Vitess Locally</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">User Guide</h4>
          <ul style="display: none">
            <li><a href="/user-guide/introduction.html">Introduction</a>
            <li><a href="/user-guide/client-libraries.html">Client Libraries</a>
            <li><a href="/user-guide/backup-and-restore.html">Backing Up Data</a>
            <li><a href="/user-guide/reparenting.html">Reparenting</a></li>
            <li><a href="/user-guide/schema-management.html">Schema Management</a></li>
            <li style="padding-bottom: 0"><a href="/user-guide/sharding.html">Sharding</a>
              <ul style="list-style-type: none">
                <li><a href="/user-guide/horizontal-sharding.html">Horizontal Sharding (Codelab)</a></li>
                <li style="padding-bottom: 0"><a href="/user-guide/sharding-kubernetes.html">Sharding in Kubernetes (Codelab)</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Reference Guides</h4>
          <ul style="display: none">
            <li><a href="/reference/vitess-api.html">Vitess API</a>
            <li><a href="/reference/vtctl.html">vtctl Commands</a>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Other Resources</h4>
          <ul style="display: none">
            <li><a href="/resources/presentations.html">Presentations</a>
          </ul>
        </li>

        <li><a href="https://github.com/youtube/vitess" style="font-size: 18px; margin-left: 0.25em;"><i class="fa fa-github"></i> GitHub</a></li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>



<div id="masthead">
  <div class="container">
    <div class="row">
      <div class="col-md-9">
        <h1>Sharding in Kubernetes</h1>
      </div>
    </div>
  </div>
</div>


<div class="container">
    <div class="row scroll-margin" id="toc-content-row">
    <div class="col-md-3" id="leftCol">
      <ul class="nav nav-stacked mobile-left-nav-menu" id="sidebar">
                <li class="submenu">
          <h4 class="arrow-r no-top-margin">Overview</h4>
          <ul style="display: none">
            <li><a href="/overview/">What is Vitess</a></li>
            <li><a href="/overview/concepts.html">Key Concepts</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Getting Started</h4>
          <ul style="display: none">
            <li><a href="/getting-started/">Run Vitess on Kubernetes</a></li>
            <li><a href="/getting-started/local-instance.html">Run Vitess Locally</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">User Guide</h4>
          <ul style="display: none">
            <li><a href="/user-guide/introduction.html">Introduction</a>
            <li><a href="/user-guide/client-libraries.html">Client Libraries</a>
            <li><a href="/user-guide/backup-and-restore.html">Backing Up Data</a>
            <li><a href="/user-guide/reparenting.html">Reparenting</a></li>
            <li><a href="/user-guide/schema-management.html">Schema Management</a></li>
            <li style="padding-bottom: 0"><a href="/user-guide/sharding.html">Sharding</a>
              <ul style="list-style-type: none">
                <li><a href="/user-guide/horizontal-sharding.html">Horizontal Sharding (Codelab)</a></li>
                <li style="padding-bottom: 0"><a href="/user-guide/sharding-kubernetes.html">Sharding in Kubernetes (Codelab)</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Reference Guides</h4>
          <ul style="display: none">
            <li><a href="/reference/vitess-api.html">Vitess API</a>
            <li><a href="/reference/vtctl.html">vtctl Commands</a>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Other Resources</h4>
          <ul style="display: none">
            <li><a href="/resources/presentations.html">Presentations</a>
          </ul>
        </li>

      </ul>
    </div>
    <div class="col-md-2" id="rightCol">
      <div class="nav nav-stacked" id="tocSidebar">
        <div id="toc"></div>
      </div>
    </div>
    <div class="col-md-7" id="centerCol">
      <div id="centerTextCol">
        <p>This guide walks you through the process of sharding an existing unsharded
Vitess <a href="http://vitess.io/overview/concepts.html#keyspace">keyspace</a> in
<a href="http://kubernetes.io/">Kubernetes</a>.</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>We begin by assuming you&#39;ve completed the
<a href="http://vitess.io/getting-started/">Getting Started on Kubernetes</a> guide, and
have left the cluster running.</p>

<h2 id="overview">Overview</h2>

<p>We will follow a process similar to the one in the general
<a href="http://vitess.io/user-guide/horizontal-sharding.html">Horizontal Sharding</a>
guide, except that here we&#39;ll give the exact commands you&#39;ll need to do it for
the example Vitess cluster in Kubernetes.</p>

<p>Since Vitess makes <a href="http://vitess.io/user-guide/sharding.html">sharding</a>
transparent to the app layer, the
<a href="https://github.com/youtube/vitess/tree/master/examples/kubernetes/guestbook">Guestbook</a>
sample app will stay live throughout the
<a href="http://vitess.io/user-guide/sharding.html#resharding">resharding</a> process,
confirming that the Vitess cluster continues to serve without downtime.</p>

<h2 id="configure-sharding-information">Configure sharding information</h2>

<p>The first step is to tell Vitess the name and type of our
<a href="http://vitess.io/overview/concepts.html#keyspace-id">keyspace_id</a> column:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes<span class="nv">$ </span>./kvtctl.sh SetKeyspaceShardingInfo test_keyspace keyspace_id uint64
</code></pre></div>
<p>This column was added in the original
<a href="https://github.com/youtube/vitess/blob/master/examples/kubernetes/create_test_table.sql">schema</a>
for the unsharded example, although it was unnecessary there.
As a result, the Guestbook app is already sharding-ready,
so we don&#39;t need to change anything at the app layer to shard the database.</p>

<p>If the app hadn&#39;t originally been sharding-ready, we would need to alter
the tables to add the <em>keyspace_id</em> column, back-fill it with a suitable hash
of the sharding key, and include the <em>keyspace_id</em> in each query sent to VTGate.</p>

<p>See the <a href="http://vitess.io/user-guide/sharding.html#range-based-sharding">sharding guide</a>
and the <a href="https://github.com/youtube/vitess/blob/master/examples/kubernetes/guestbook/main.py">Guestbook source</a>
for more about how this column is used.</p>

<h2 id="bring-up-tablets-for-new-shards">Bring up tablets for new shards</h2>

<p>In the unsharded example, you started tablets for a shard
named <em>0</em> in <em>test_keyspace</em>, written as <em>test_keyspace/0</em>.
Now you&#39;ll start tablets for two additional shards,
named <em>test_keyspace/-80</em> and <em>test_keyspace/80-</em>:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes<span class="nv">$ </span>./sharded-vttablet-up.sh
<span class="c">### example output:</span>
<span class="c"># Creating test_keyspace.shard--80 pods in cell test...</span>
<span class="c"># ...</span>
<span class="c"># Creating test_keyspace.shard-80- pods in cell test...</span>
<span class="c"># ...</span>
</code></pre></div>
<p>Since the sharding key in the Guestbook app is the page number,
this will result in half the pages going to each shard,
since <em>0x80</em> is the midpoint of the
<a href="http://vitess.io/user-guide/sharding.html#key-ranges-and-partitions">sharding key range</a>.</p>

<p>These new shards will run in parallel with the original shard during the
transition, but actual traffic will be served only by the original shard
until we tell it to switch over.</p>

<p>Check the <code class="prettyprint">vtctld</code> web UI, or the output of <code class="prettyprint">kvtctl.sh ListAllTablets test</code>,
to see when the tablets are ready. There should be 5 tablets in each shard.</p>

<p>Once the tablets are ready, initialize replication by electing the first master
for each of the new shards:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes<span class="nv">$ </span>./kvtctl.sh InitShardMaster -force test_keyspace/-80 <span class="nb">test</span>-0000000200
vitess/examples/kubernetes<span class="nv">$ </span>./kvtctl.sh InitShardMaster -force test_keyspace/80- <span class="nb">test</span>-0000000300
</code></pre></div>
<p>Now there should be a total of 15 tablets, with one master for each shard:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes<span class="nv">$ </span>./kvtctl.sh ListAllTablets <span class="nb">test</span>
<span class="c">### example output:</span>
<span class="c"># test-0000000100 test_keyspace 0 master 10.64.3.4:15002 10.64.3.4:3306 []</span>
<span class="c"># ...</span>
<span class="c"># test-0000000200 test_keyspace -80 master 10.64.0.7:15002 10.64.0.7:3306 []</span>
<span class="c"># ...</span>
<span class="c"># test-0000000300 test_keyspace 80- master 10.64.0.9:15002 10.64.0.9:3306 []</span>
<span class="c"># ...</span>
</code></pre></div>
<h2 id="copy-data-from-original-shard">Copy data from original shard</h2>

<p>The new tablets start out empty, so we need to copy everything from the
original shard to the two new ones, starting with the schema:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes<span class="nv">$ </span>./kvtctl.sh CopySchemaShard test_keyspace/0 test_keyspace/-80
vitess/examples/kubernetes<span class="nv">$ </span>./kvtctl.sh CopySchemaShard test_keyspace/0 test_keyspace/80-
</code></pre></div>
<p>Next we copy the data. Since the amount of data to copy can be very large,
we use a special batch process called <code class="prettyprint">vtworker</code> to stream the data from a
single source to multiple destinations, routing each row based on its
<em>keyspace_id</em>:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes<span class="nv">$ </span>./sharded-vtworker.sh SplitClone --strategy<span class="o">=</span>-populate_blp_checkpoint test_keyspace/0
<span class="c">### example output:</span>
<span class="c"># Creating vtworker pod in cell test...</span>
<span class="c"># pods/vtworker</span>
<span class="c"># Following vtworker logs until termination...</span>
<span class="c"># I0627 23:57:51.118768      10 vtworker.go:99] Starting worker...</span>
<span class="c"># ...</span>
<span class="c"># State: done</span>
<span class="c"># Success:</span>
<span class="c"># messages: copy done, copied 3 rows</span>
<span class="c"># Deleting vtworker pod...</span>
<span class="c"># pods/vtworker</span>
</code></pre></div>
<p>Notice that we&#39;ve only specified the source shard, <em>test_keyspace/0</em>.
The <em>SplitClone</em> process will automatically figure out which shards to use
as the destinations based on the key range that needs to be covered.
In this case, shard <em>0</em> covers the entire range, so it identifies
<em>-80</em> and <em>80-</em> as the destination shards, since they combine to cover the
same range.</p>

<p>Next, it will pause replication on one <em>rdonly</em> (offline processing) tablet
to serve as a consistent snapshot of the data. The app can continue without
downtime, since live traffic is served by <em>replica</em> and <em>master</em> tablets,
which are unaffected. Other batch jobs will also be unaffected, since they
will be served only by the remaining, un-paused <em>rdonly</em> tablets.</p>

<h2 id="check-filtered-replication">Check filtered replication</h2>

<p>Once the copy from the paused snapshot finishes, <code class="prettyprint">vtworker</code> turns on
<a href="http://vitess.io/user-guide/sharding.html#filtered-replication">filtered replication</a>
from the source shard to each destination shard. This allows the destination
shards to catch up on updates that have continued to flow in from the app since
the time of the snapshot.</p>

<p>When the destination shards are caught up, they will continue to replicate
new updates. You can see this by looking at the contents of each shard as
you add new messages to various pages in the Guestbook app. Shard <em>0</em> will
see all the messages, while the new shards will only see messages for pages
that live on that shard.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c"># See what&#39;s on shard test_keyspace/0:</span>
vitess/examples/kubernetes<span class="nv">$ </span>./kvtctl.sh ExecuteFetchAsDba <span class="nb">test</span>-0000000100 <span class="s2">&quot;SELECT * FROM messages&quot;</span>
<span class="c"># See what&#39;s on shard test_keyspace/-80:</span>
vitess/examples/kubernetes<span class="nv">$ </span>./kvtctl.sh ExecuteFetchAsDba <span class="nb">test</span>-0000000200 <span class="s2">&quot;SELECT * FROM messages&quot;</span>
<span class="c"># See what&#39;s on shard test_keyspace/80-:</span>
vitess/examples/kubernetes<span class="nv">$ </span>./kvtctl.sh ExecuteFetchAsDba <span class="nb">test</span>-0000000300 <span class="s2">&quot;SELECT * FROM messages&quot;</span>
</code></pre></div>
<p>Add some messages on various pages of the Guestbook to see how they get routed.</p>

<h2 id="check-copied-data-integrity">Check copied data integrity</h2>

<p>The <code class="prettyprint">vtworker</code> batch process has another mode that will compare the source
and destination to ensure all the data is present and correct.
The following commands will run a diff for each destination shard:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes<span class="nv">$ </span>./sharded-vtworker.sh SplitDiff test_keyspace/-80
vitess/examples/kubernetes<span class="nv">$ </span>./sharded-vtworker.sh SplitDiff test_keyspace/80-
</code></pre></div>
<p>If any discrepancies are found, they will be printed.
If everything is good, you should see something like this:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">Table messages checks out (4 rows processed, 1072961 qps)
</code></pre></div>
<h2 id="switch-over-to-new-shards">Switch over to new shards</h2>

<p>Now we&#39;re ready to switch over to serving from the new shards.
The <a href="http://vitess.io/reference/vtctl.html#migrateservedtypes">MigrateServedTypes</a>
command lets you do this one
<a href="http://vitess.io/overview/concepts.html#tablet">tablet type</a> at a time,
and even one <a href="http://vitess.io/overview/concepts.html#cell-data-center">cell</a>
at a time. The process can be rolled back at any point <em>until</em> the master is
switched over.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes<span class="nv">$ </span>./kvtctl.sh MigrateServedTypes test_keyspace/0 rdonly
vitess/examples/kubernetes<span class="nv">$ </span>./kvtctl.sh MigrateServedTypes test_keyspace/0 replica
vitess/examples/kubernetes<span class="nv">$ </span>./kvtctl.sh MigrateServedTypes test_keyspace/0 master
</code></pre></div>
<p>During the <em>master</em> migration, the original shard master will first stop
accepting updates. Then the process will wait for the new shard masters to
fully catch up on filtered replication before allowing them to begin serving.
Since filtered replication has been following along with live updates, there
should only be a few seconds of master unavailability.</p>

<p>When the master traffic is migrated, the filtered replication will be stopped.
Data updates will be visible on the new shards, but not on the original shard.
See it for yourself: Add a message to the guestbook page and then inspect
the database content:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c"># See what&#39;s on shard test_keyspace/0</span>
<span class="c"># (no updates visible since we migrated away from it):</span>
vitess/examples/kubernetes<span class="nv">$ </span>./kvtctl.sh ExecuteFetchAsDba <span class="nb">test</span>-0000000100 <span class="s2">&quot;SELECT * FROM messages&quot;</span>
<span class="c"># See what&#39;s on shard test_keyspace/-80:</span>
vitess/examples/kubernetes<span class="nv">$ </span>./kvtctl.sh ExecuteFetchAsDba <span class="nb">test</span>-0000000200 <span class="s2">&quot;SELECT * FROM messages&quot;</span>
<span class="c"># See what&#39;s on shard test_keyspace/80-:</span>
vitess/examples/kubernetes<span class="nv">$ </span>./kvtctl.sh ExecuteFetchAsDba <span class="nb">test</span>-0000000300 <span class="s2">&quot;SELECT * FROM messages&quot;</span>
</code></pre></div>
<h2 id="remove-original-shard">Remove original shard</h2>

<p>Now that all traffic is being served from the new shards, we can remove the
original one. To do that, we use the <code class="prettyprint">vttablet-down.sh</code> script from the
unsharded example:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes<span class="nv">$ </span>./vttablet-down.sh
<span class="c">### example output:</span>
<span class="c"># Removing tablet test-0000000100 from Vitess topology...</span>
<span class="c"># Deleting pod for tablet test-0000000100...</span>
<span class="c"># pods/vttablet-100</span>
<span class="c"># ...</span>
</code></pre></div>
<p>Then we can delete the now-empty shard:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes<span class="nv">$ </span>./kvtctl.sh DeleteShard test_keyspace/0
</code></pre></div>
<p>You should then see in the vtctld <strong>Topology</strong> page, or in the output of
<code class="prettyprint">kvtctl.sh ListAllTablets test</code> that the tablets for shard <em>0</em> are gone.</p>

<h2 id="tear-down-and-clean-up">Tear down and clean up</h2>

<p>Before stopping the Container Engine cluster, you should tear down the Vitess
services. Kubernetes will then take care of cleaning up any entities it created
for those services, like external load balancers.</p>

<p>Since you already cleaned up the tablets from the original unsharded example by
running <code class="prettyprint">./vttablet-down.sh</code>, that step has been replaced with
<code class="prettyprint">./sharded-vttablet-down.sh</code> to clean up the new sharded tablets.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes<span class="nv">$ </span>./guestbook-down.sh
vitess/examples/kubernetes<span class="nv">$ </span>./vtgate-down.sh
vitess/examples/kubernetes<span class="nv">$ </span>./sharded-vttablet-down.sh
vitess/examples/kubernetes<span class="nv">$ </span>./vtctld-down.sh
vitess/examples/kubernetes<span class="nv">$ </span>./etcd-down.sh
</code></pre></div>
<p>Then tear down the Container Engine cluster itself, which will stop the virtual
machines running on Compute Engine:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>gcloud beta container clusters delete example
</code></pre></div>
<p>It&#39;s also a good idea to remove the firewall rules you created, unless you plan
to use them again soon:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>gcloud compute firewall-rules delete vtctld guestbook
</code></pre></div>
      </div>
    </div>
  </div>

</div>


        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<!--    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>   -->
    <!-- Include all compiled plugins (below), or include individual files as needed -->
<!--
    <script src="/libs/bootstrap/js/bootstrap.min.js"></script>
-->
    <!-- Include the common site javascript -->
    <script src="/js/common.js" type="text/javascript" charset="utf-8"></script>


    <!-- GA -->
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  if (window.location.hostname == 'youtube.github.io') {
    ga('create', 'UA-60219601-1', 'auto');
    ga('send', 'pageview');
  }
</script>

  </body>
</html>
